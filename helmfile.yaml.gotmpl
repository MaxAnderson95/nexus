# Helmfile for NEXUS Station Multi-Namespace Deployment
#
# Usage:
#   helmfile apply                              # Deploy all services
#   helmfile -l name=power apply                # Deploy single service
#   helmfile destroy                            # Remove all services
#   ENABLE_LOAD_GENERATOR=true helmfile apply   # Include load generator
#
# Prerequisites:
#   - Helm 3.x
#   - Helmfile (https://github.com/helmfile/helmfile)
#   - kubectl configured for target cluster

helmDefaults:
  createNamespace: true
  wait: true
  timeout: 300
  atomic: true
  skipDeps: true

# Common values applied to all releases
commonLabels:
  app.kubernetes.io/part-of: nexus-station

environments:
  default:
    values:
      - imageTag: "latest"
      - postgresPassword: "nexus_password"
  production:
    values:
      - imageTag: "v1.0.0"
      - postgresPassword: '{{ env "POSTGRES_PASSWORD" | default "nexus_password" }}'

---
releases:
  # Infrastructure (PostgreSQL + Redis) - must be deployed first
  # Note: dash0Monitoring not enabled - PostgreSQL/Redis don't benefit from OTel instrumentation
  - name: infra
    namespace: nexus-infra
    chart: ./charts/nexus-infra
    values:
      - postgres:
          auth:
            password: {{ .Values.postgresPassword }}

  # Power Service - base service with no service dependencies
  - name: power
    namespace: nexus-power
    chart: ./charts/nexus-power
    needs:
      - nexus-infra/infra
    values:
      - image:
          tag: {{ .Values.imageTag }}
          {{- if eq .Values.imageTag "latest" }}
          pullPolicy: IfNotPresent
          {{- end }}
      - database:
          password: {{ .Values.postgresPassword }}
      - dash0Monitoring:
          enabled: true

  # Life Support Service - depends on power
  - name: life-support
    namespace: nexus-life-support
    chart: ./charts/nexus-life-support
    needs:
      - nexus-infra/infra
      - nexus-power/power
    values:
      - image:
          tag: {{ .Values.imageTag }}
          {{- if eq .Values.imageTag "latest" }}
          pullPolicy: IfNotPresent
          {{- end }}
      - database:
          password: {{ .Values.postgresPassword }}
      - dash0Monitoring:
          enabled: true

  # Crew Service - depends on life-support
  - name: crew
    namespace: nexus-crew
    chart: ./charts/nexus-crew
    needs:
      - nexus-infra/infra
      - nexus-life-support/life-support
    values:
      - image:
          tag: {{ .Values.imageTag }}
          {{- if eq .Values.imageTag "latest" }}
          pullPolicy: IfNotPresent
          {{- end }}
      - database:
          password: {{ .Values.postgresPassword }}
      - dash0Monitoring:
          enabled: true

  # Inventory Service - depends on crew (and docking, but deployed together)
  - name: inventory
    namespace: nexus-inventory
    chart: ./charts/nexus-inventory
    needs:
      - nexus-infra/infra
      - nexus-crew/crew
    values:
      - image:
          tag: {{ .Values.imageTag }}
          {{- if eq .Values.imageTag "latest" }}
          pullPolicy: IfNotPresent
          {{- end }}
      - database:
          password: {{ .Values.postgresPassword }}
      - dash0Monitoring:
          enabled: true

  # Docking Service - depends on power, crew, inventory
  - name: docking
    namespace: nexus-docking
    chart: ./charts/nexus-docking
    needs:
      - nexus-infra/infra
      - nexus-power/power
      - nexus-crew/crew
      - nexus-inventory/inventory
    values:
      - image:
          tag: {{ .Values.imageTag }}
          {{- if eq .Values.imageTag "latest" }}
          pullPolicy: IfNotPresent
          {{- end }}
      - database:
          password: {{ .Values.postgresPassword }}
      - dash0Monitoring:
          enabled: true

  # Cortex (BFF + Frontend) - depends on all backend services
  - name: cortex
    namespace: nexus-cortex
    chart: ./charts/nexus-cortex
    needs:
      - nexus-docking/docking
    values:
      - image:
          tag: {{ .Values.imageTag }}
          {{- if eq .Values.imageTag "latest" }}
          pullPolicy: IfNotPresent
          {{- end }}
      - database:
          password: {{ .Values.postgresPassword }}
      - dash0Monitoring:
          enabled: true

  # Load Generator (optional) - depends on cortex
  - name: load-generator
    namespace: nexus-load-gen
    chart: ./charts/nexus-load-generator
    installed: {{ env "ENABLE_LOAD_GENERATOR" | default "false" }}
    needs:
      - nexus-cortex/cortex
    values:
      - image:
          tag: {{ .Values.imageTag }}
          {{- if eq .Values.imageTag "latest" }}
          pullPolicy: IfNotPresent
          {{- end }}
      - dash0Monitoring:
          enabled: true
