{{- if .Values.postgres.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "nexus-station.fullname" . }}-postgres-init
  labels:
    {{- include "nexus-station.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgres-init
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 5
  activeDeadlineSeconds: 300
  template:
    metadata:
      labels:
        {{- include "nexus-station.selectorLabels" (dict "context" . "component" "postgres-init") | nindent 8 }}
    spec:
      {{- include "nexus-station.imagePullSecrets" . | nindent 6 }}
      restartPolicy: OnFailure
      containers:
        - name: init
          image: {{ include "nexus-station.image" (dict "context" . "image" .Values.postgres.image) | quote }}
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for PostgreSQL to be ready..."
              until pg_isready -h {{ include "nexus-station.fullname" . }}-postgres -p 5432 -U {{ .Values.postgres.auth.username }}; do
                echo "PostgreSQL is not ready yet. Waiting..."
                sleep 2
              done
              echo "PostgreSQL is ready. Running init script..."
              PGPASSWORD={{ .Values.postgres.auth.password }} psql \
                -h {{ include "nexus-station.fullname" . }}-postgres \
                -p 5432 \
                -U {{ .Values.postgres.auth.username }} \
                -d {{ .Values.postgres.auth.database }} \
                -f /init/init.sql
              echo "Database initialization complete."
          volumeMounts:
            - name: init-script
              mountPath: /init
      volumes:
        - name: init-script
          configMap:
            name: {{ include "nexus-station.fullname" . }}-postgres-init
{{- end }}
